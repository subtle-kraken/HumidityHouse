#include <WiFi.h>
#include <HTTPClient.h>

// üîπ D√©finition des identifiants WiFi
const char* ssid = "TON_WIFI";  // ‚ö†Ô∏è Remplace par ton WiFi
const char* password = "TON_MOT_DE_PASSE";  // ‚ö†Ô∏è Remplace par ton mot de passe WiFi

// üîπ D√©finition de l'URL Firebase (avec `/data.json`)
const char* firebaseURL = "https://esp32-data-xxxxxxxxxxxxxxxxxxx.firebasedatabase.app/data.json";  // ‚ö†Ô∏è Remplace par ton URL Firebase

void setup() {
  Serial.begin(115200);
  Serial2.begin(115200, SERIAL_8N1, 16, 17); // RX2 = GPIO 16

  WiFi.begin(ssid, password);
  Serial.print("Connexion au WiFi...");

  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }

  Serial.println("\n‚úÖ WiFi connect√© !");
}

void loop() {
  if (Serial2.available()) {
    String data = Serial2.readStringUntil('\n');
    data.trim();

    Serial.println("üì© Donn√©es re√ßues de l‚ÄôUno : " + data);

    int sep = data.indexOf(',');
    if (sep != -1) {
      String temp = data.substring(0, sep);
      String hum = data.substring(sep + 1);

      Serial.print("üì° Temp√©rature : ");
      Serial.print(temp);
      Serial.print("¬∞C | Humidit√© : ");
      Serial.print(hum);
      Serial.println("%");

      if (temp.length() > 0 && hum.length() > 0) {
        // üîπ Construction du JSON
        String payload = "{\"temperature\":" + temp + ",\"humidity\":" + hum + "}";

        Serial.println("üåç Envoi des donn√©es √† Firebase : " + payload);

        if (WiFi.status() == WL_CONNECTED) {
          HTTPClient http;
          http.begin(firebaseURL);  // ‚úÖ `firebaseURL` est bien d√©fini ici
          http.addHeader("Content-Type", "application/json");
          int httpCode = http.PUT(payload);  // üîπ Utilise `PUT` pour remplacer les donn√©es

          if (httpCode > 0) {
            Serial.println("‚úÖ Donn√©es envoy√©es avec succ√®s sur Firebase !");
          } else {
            Serial.print("‚ùå Erreur d'envoi des donn√©es ! Code HTTP : ");
            Serial.println(httpCode);
          }

          http.end();
        } else {
          Serial.println("‚ùå WiFi d√©connect√© !");
        }
      } else {
        Serial.println("‚ùå Valeurs invalides re√ßues !");
      }
    }
  }

  delay(5000);
}
